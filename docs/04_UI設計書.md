# UI設計書（Streamlit）

## 画面構成

### 全体レイアウト
```
┌─────────────────────────────────────────┐
│  エクセルデータ加工システム              │  ← タイトル
├─────────────────────────────────────────┤
│  📁 ファイルアップロード                 │
│  ┌────────────────────────────────────┐ │
│  │ 前回データをアップロード            │ │
│  │ [ファイル選択]                     │ │
│  │ ✅ sample_前回データ.xlsx          │ │
│  └────────────────────────────────────┘ │
│  ┌────────────────────────────────────┐ │
│  │ 今回データをアップロード            │ │
│  │ [ファイル選択]                     │ │
│  │ ✅ sample_今回データ.xlsx          │ │
│  └────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│  ⚡ 処理実行                            │
│  [データ処理を実行] ボタン              │
│  🔄 処理中...                          │  ← スピナー
├─────────────────────────────────────────┤
│  ✅ 処理完了しました！                  │  ← 成功メッセージ
│  📊 結果: 3シート生成                   │
│  - 前回データ: 150行                    │
│  - 今回データ: 152行                    │
│  - 比較データ: 155行                    │
│                                         │
│  [📥 結果をダウンロード] ボタン         │
└─────────────────────────────────────────┘
```

---

## Streamlit コード構成

### app.py の基本構造
```python
import streamlit as st
import pandas as pd
from datetime import datetime
from io import BytesIO

# モジュールのimport
from modules.data_processor import process_excel_files
from utils.file_validator import validate_file

# ページ設定
st.set_page_config(
    page_title="エクセルデータ加工システム",
    page_icon="📊",
    layout="centered"
)

# タイトル
st.title("📊 エクセルデータ加工システム")
st.markdown("---")

# セクション1: ファイルアップロード
st.header("📁 ファイルアップロード")

# セクション2: 処理実行
st.header("⚡ データ処理")

# セクション3: ダウンロード
st.header("📥 結果ダウンロード")
```

---

## セクション別実装仕様

### セクション1: ファイルアップロード

#### 実装コード
```python
st.header("📁 ファイルアップロード")

col1, col2 = st.columns(2)

with col1:
    st.subheader("前回データ")
    previous_file = st.file_uploader(
        "前回データをアップロード",
        type=['xlsx'],
        key="previous"
    )
    if previous_file:
        st.success(f"✅ {previous_file.name}")

with col2:
    st.subheader("今回データ")
    current_file = st.file_uploader(
        "今回データをアップロード",
        type=['xlsx'],
        key="current"
    )
    if current_file:
        st.success(f"✅ {current_file.name}")
```

#### 表示条件

| 状態 | 表示 |
|------|------|
| ファイル未選択 | ファイル選択ボタンのみ |
| ファイル選択済み | ✅ ファイル名を表示 |
| 両方選択済み | 処理実行ボタンを有効化 |

---

### セクション2: 処理実行

#### 実装コード
```python
st.header("⚡ データ処理")

# ボタンの有効化条件
if previous_file and current_file:
    if st.button("🚀 データ処理を実行", type="primary", use_container_width=True):
        try:
            with st.spinner("処理中です...しばらくお待ちください"):
                # バリデーション
                validate_file(previous_file, "前回データ")
                validate_file(current_file, "今回データ")
                
                # メイン処理
                output_buffer, stats = process_excel_files(
                    previous_file, 
                    current_file
                )
                
                # セッション状態に保存
                st.session_state['output'] = output_buffer
                st.session_state['stats'] = stats
                st.session_state['processed'] = True
            
            # 成功メッセージ
            st.success("✅ 処理が完了しました！")
            st.info(f"""
            📊 **処理結果**
            - 前回データ: {stats['previous_rows']}行
            - 今回データ: {stats['current_rows']}行
            - 比較データ: {stats['comparison_rows']}行
            """)
        
        except Exception as e:
            st.error(f"❌ エラーが発生しました: {str(e)}")
            st.session_state['processed'] = False
else:
    st.warning("⚠️ 両方のファイルをアップロードしてください")
```

#### スピナーメッセージ
```python
with st.spinner("処理中です...しばらくお待ちください"):
    # 処理実行
```

---

### セクション3: ダウンロード

#### 実装コード
```python
st.header("📥 結果ダウンロード")

if st.session_state.get('processed', False):
    output_buffer = st.session_state['output']
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    filename = f"output_{timestamp}.xlsx"
    
    st.download_button(
        label="📥 結果をダウンロード",
        data=output_buffer,
        file_name=filename,
        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        type="primary",
        use_container_width=True
    )
else:
    st.info("💡 処理を実行すると、ダウンロードボタンが表示されます")
```

---

## エラーメッセージ仕様

### エラーレベルと表示方法

| レベル | Streamlit関数 | 用途 |
|--------|--------------|------|
| エラー | `st.error()` | 処理失敗、ファイル不正 |
| 警告 | `st.warning()` | ファイル未選択、データ不足 |
| 情報 | `st.info()` | 処理待ち、ガイダンス |
| 成功 | `st.success()` | 処理完了、ファイル読み込み成功 |

### 主要エラーメッセージ一覧
```python
# ファイル未選択
st.warning("⚠️ 両方のファイルをアップロードしてください")

# ファイル形式エラー
st.error("❌ .xlsx形式のファイルをアップロードしてください")

# カラム不足エラー
st.error("❌ 必須カラム（stationid, railroad）が見つかりません")

# 処理失敗
st.error(f"❌ エラーが発生しました: {str(e)}")

# データなし
st.warning("⚠️ データ行が見つかりませんでした")

# 処理成功
st.success("✅ 処理が完了しました！")
```

---

## セッション状態管理

### 使用する状態変数
```python
# 初期化（app.py の最初）
if 'processed' not in st.session_state:
    st.session_state['processed'] = False
if 'output' not in st.session_state:
    st.session_state['output'] = None
if 'stats' not in st.session_state:
    st.session_state['stats'] = None
```

| 変数名 | 型 | 用途 |
|--------|----|----|
| `processed` | bool | 処理完了フラグ |
| `output` | BytesIO | 出力Excelのバイナリ |
| `stats` | dict | 処理統計情報 |

---

## UI実装のポイント

### ✅ やるべきこと

- `st.columns()` で左右2列レイアウト
- `st.spinner()` で処理中表示
- `st.session_state` で状態管理
- `type="primary"` で目立つボタン
- `use_container_width=True` で幅を最大化

### ❌ やってはいけないこと

- ファイルアップロード時に即座に処理開始（ボタンで制御）
- エラー時に詳細なスタックトレースを表示（ユーザーフレンドリーに）
- 処理中にページをブロック（spinnerを使用）

---

## 次のステップ

**05_エラーハンドリング仕様書.md を読んで、エラー処理の全パターンを理解してください**