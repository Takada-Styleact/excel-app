# 全体設計書

## システム概要

### 目的
2つのExcelファイル（前回データ・今回データ）を比較・加工し、3シートを含む1つのExcelファイルを出力する

### 処理フロー
```
[ユーザー] 
   ↓ ファイルアップロード
[前回データ.xlsx] → [システム] ← [今回データ.xlsx]
   ↓ 処理実行
[出力ファイル.xlsx]
   ├── シート1: 前回データ（そのまま）
   ├── シート2: 今回データ（J〜M列を計算）
   └── シート3: 比較データ（前回vs今回）
   ↓ ダウンロード
[ユーザー]
```

---

## 技術スタック

| 項目 | 採用技術 |
|------|----------|
| プログラミング言語 | Python 3.9+ |
| Webフレームワーク | Streamlit |
| Excelライブラリ | openpyxl, pandas |
| 数値計算 | numpy |
| 開発環境 | VS Code + Claude Code |

---

## システムアーキテクチャ

### レイヤー構成
```
[Presentation Layer]
├── app.py (Streamlit UI)

[Business Logic Layer]
├── modules/data_processor.py   (メイン処理フロー)
├── modules/calculator.py       (計算ロジック)
└── modules/matcher.py          (マッチング処理)

[Data Access Layer]
├── utils/excel_handler.py      (Excel読み書き)
└── utils/file_validator.py     (ファイル検証)
```

### データフロー
```
1. ファイルアップロード
   ↓
2. ファイル検証 (file_validator.py)
   ↓
3. Excel読み込み (excel_handler.py)
   ↓
4. 今回データの計算 (calculator.py)
   ↓
5. データマッチング (matcher.py)
   ↓
6. 比較データの計算 (calculator.py)
   ↓
7. 3シート生成 (data_processor.py)
   ↓
8. Excelファイル出力 (excel_handler.py)
   ↓
9. ダウンロード提供 (app.py)
```

---

## 主要機能一覧

### 1. ファイルアップロード機能
- 前回データのアップロード
- 今回データのアップロード
- ファイル形式チェック（.xlsx）
- カラム構成の検証

### 2. データ加工機能
- 今回データのJ〜M列計算
- エラー値の「データなし」変換

### 3. データマッチング機能
- stationid + railroad でマッチング
- 両方存在/片方のみ存在の全パターン処理

### 4. 比較データ生成機能
- 差異計算（今回 - 前回）
- 値上げ率計算（切り上げ）

### 5. ファイル出力機能
- 3シートのExcel生成
- 備考行・ヘッダー行の保持
- タイムスタンプ付きファイル名

---

## 非機能要件

### 性能要件
- **処理時間**: 3,000行を1分以内に処理
- **ファイルサイズ**: 最大10MB

### 可用性
- **ブラウザ対応**: Chrome, Edge, Safari, Firefox 最新版
- **エラー時**: 適切なメッセージ表示

### セキュリティ
- アップロードファイルは処理後メモリから削除
- 個人情報は含まれない想定

### 保守性
- モジュール化による責務分離
- 各関数にdocstring記載
- 変数名は日本語ドメイン用語を使用可

---

## 制約事項

1. **Excel形式**: `.xlsx` のみ対応（.xlsは非対応）
2. **ファイル構造**: 1行目=備考、2行目=ヘッダーを必須とする
3. **カラム順序**: A〜M列の順序固定
4. **データ型**: 数値列に文字列混在は非対応

---

## 次のステップ

**02_データ仕様書.md を読んで、ファイル構造の詳細を理解してください**