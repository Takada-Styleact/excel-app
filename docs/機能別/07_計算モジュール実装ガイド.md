# 計算モジュール実装ガイド

## 対象ファイル
`modules/calculator.py`

## このモジュールの役割
- 今回データのJ〜M列を計算
- 比較データのH, I列を計算
- エラー値を「データなし」に変換

---

## 実装する関数

### 1. calculate_j_k_l_m_columns()

#### 目的
今回データのJ〜M列を一括計算

#### シグネチャ
```python
def calculate_j_k_l_m_columns(df: pd.DataFrame) -> pd.DataFrame:
    """
    J〜M列を計算してDataFrameに追加
    
    Args:
        df: 今回データのDataFrame（F, G, H列を含む）
    
    Returns:
        J〜M列が追加されたDataFrame
    """
```

#### 実装
```python
import pandas as pd
import math

def calculate_j_k_l_m_columns(df):
    """
    J〜M列を計算してDataFrameに追加
    """
    def calc_price(value):
        """坪単価換算"""
        if pd.isna(value) or value == 0:
            return "データなし"
        result = round(value * 0.3025 * 70, 0)
        return int(result)
    
    # J列: 新築換算平均価格
    df['新築換算平均価格'] = df['priceunitconvnewly'].apply(calc_price)
    
    # K列: 新築時平均価格
    df['新築時平均価格'] = df['priceunitnewly'].apply(calc_price)
    
    # L列: 中古平均価格
    df['中古平均価格'] = df['priceunitusedsigned'].apply(calc_price)
    
    # M列: 新築換算ー中古
    def calc_diff(row):
        j = row['新築換算平均価格']
        l = row['中古平均価格']
        if j == "データなし" or l == "データなし":
            return "データなし"
        return int(j - l)
    
    df['新築換算ー中古'] = df.apply(calc_diff, axis=1)
    
    return df
```

---

### 2. calculate_comparison_columns()

#### 目的
比較データのH, I列を計算

#### シグネチャ
```python
def calculate_comparison_columns(df: pd.DataFrame) -> pd.DataFrame:
    """
    比較データのH列（差異）とI列（値上げ率）を計算
    
    Args:
        df: 比較データのDataFrame
            （前回新築換算平均価格, 今回新築換算平均価格を含む）
    
    Returns:
        H, I列が追加されたDataFrame
    """
```

#### 実装
```python
def calculate_comparison_columns(df):
    """
    比較データのH列（差異）とI列（値上げ率）を計算
    """
    def calc_diff(row):
        """差異計算"""
        prev = row['前回新築換算平均価格']
        curr = row['今回新築換算平均価格']
        
        if (prev == "データなし" or curr == "データなし" or
            pd.isna(prev) or pd.isna(curr)):
            return "データなし"
        
        return int(curr - prev)
    
    def calc_rate(row):
        """値上げ率計算（切り上げ）"""
        prev = row['前回新築換算平均価格']
        curr = row['今回新築換算平均価格']
        
        if (prev == "データなし" or curr == "データなし" or
            pd.isna(prev) or pd.isna(curr) or prev == 0):
            return "データなし"
        
        rate = (curr / prev - 1) * 100
        return math.ceil(rate)  # 切り上げ
    
    # H列: 差異
    df['差異'] = df.apply(calc_diff, axis=1)
    
    # I列: 値上げ率
    df['値上げ率'] = df.apply(calc_rate, axis=1)
    
    return df
```

---

## テストコード例

### tests/test_calculator.py
```python
import sys
sys.path.append('..')

from modules.calculator import calculate_j_k_l_m_columns, calculate_comparison_columns
import pandas as pd

def test_j_k_l_m():
    """
    J〜M列の計算テスト
    """
    # テストデータ
    df = pd.DataFrame({
        'stationid': [1, 2, 3],
        'priceunitconvnewly': [450000, 0, None],
        'priceunitnewly': [500000, 550000, None],
        'priceunitusedsigned': [380000, 420000, None]
    })
    
    result_df = calculate_j_k_l_m_columns(df)
    
    print("J〜M列計算結果:")
    print(result_df[['新築換算平均価格', '新築時平均価格', '中古平均価格', '新築換算ー中古']])
    
    # 検証
    assert result_df.loc[0, '新築換算平均価格'] == 9528750, "J列計算エラー"
    assert result_df.loc[1, '新築換算平均価格'] == "データなし", "0のエラー処理エラー"
    assert result_df.loc[2, '新築換算平均価格'] == "データなし", "NaNのエラー処理エラー"
    
    print("✅ テスト成功")

def test_comparison():
    """
    比較データの計算テスト
    """
    # テストデータ
    df = pd.DataFrame({
        '前回新築換算平均価格': [9000000, 9000000, "データなし"],
        '今回新築換算平均価格': [9500000, 9000000, 9500000]
    })
    
    result_df = calculate_comparison_columns(df)
    
    print("\n比較データ計算結果:")
    print(result_df[['差異', '値上げ率']])
    
    # 検証
    assert result_df.loc[0, '差異'] == 500000, "差異計算エラー"
    assert result_df.loc[0, '値上げ率'] == 6, "値上げ率（切り上げ）エラー"  # 5.56% → 6%
    assert result_df.loc[2, '差異'] == "データなし", "エラー処理エラー"
    
    print("✅ テスト成功")

if __name__ == '__main__':
    test_j_k_l_m()
    test_comparison()
```

---

## 実装時のチェックリスト

- [ ] 係数（0.3025, 70）を正確に使用
- [ ] round()で四捨五入
- [ ] int()で整数化
- [ ] 「データなし」は文字列型
- [ ] 値上げ率はmath.ceil()で切り上げ
- [ ] エラー値（NaN, 0）を適切に処理

---

## 次のステップ

**08_マッチング処理実装ガイド.md を読んで、matcher.pyを実装してください**