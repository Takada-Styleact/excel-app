# ãƒ¡ã‚¤ãƒ³å‡¦ç†å®Ÿè£…ã‚¬ã‚¤ãƒ‰

## å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
`modules/data_processor.py`

## ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å½¹å‰²
- å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’çµ±åˆ
- ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ â†’ è¨ˆç®— â†’ ãƒãƒƒãƒãƒ³ã‚° â†’ Excelå‡ºåŠ›ã®ä¸€é€£ã®æµã‚Œã‚’åˆ¶å¾¡
- å‡¦ç†çµ±è¨ˆæƒ…å ±ã‚’è¿”å´

---

## å®Ÿè£…ã™ã‚‹é–¢æ•°

### process_excel_files()

#### ç›®çš„
2ã¤ã®Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¥åŠ›ã—ã€åŠ å·¥æ¸ˆã¿Excelã‚’BytesIOã§è¿”ã™

#### ã‚·ã‚°ãƒãƒãƒ£
```python
def process_excel_files(previous_file, current_file) -> tuple[BytesIO, dict]:
    """
    Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã—ã¦3ã‚·ãƒ¼ãƒˆå‡ºåŠ›ã‚’ç”Ÿæˆ
    
    Args:
        previous_file: å‰å›ãƒ‡ãƒ¼ã‚¿ã®ãƒ•ã‚¡ã‚¤ãƒ«
        current_file: ä»Šå›ãƒ‡ãƒ¼ã‚¿ã®ãƒ•ã‚¡ã‚¤ãƒ«
    
    Returns:
        tuple: (å‡ºåŠ›Excelã®BytesIO, å‡¦ç†çµ±è¨ˆdict)
    
    Raises:
        ValueError: å‡¦ç†ã‚¨ãƒ©ãƒ¼
    """
```

#### å®Ÿè£…
```python
from io import BytesIO
from datetime import datetime
from utils.excel_handler import read_excel_with_comment, write_excel_with_sheets
from modules.calculator import calculate_j_k_l_m_columns, calculate_comparison_columns
from modules.matcher import create_comparison_dataframe

def process_excel_files(previous_file, current_file):
    """
    Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã—ã¦3ã‚·ãƒ¼ãƒˆå‡ºåŠ›ã‚’ç”Ÿæˆ
    """
    try:
        # 1. ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        previous_df, previous_comment = read_excel_with_comment(previous_file)
        current_df, current_comment = read_excel_with_comment(current_file)
        
        # 2. ä»Šå›ãƒ‡ãƒ¼ã‚¿ã®è¨ˆç®—ï¼ˆJã€œMåˆ—ï¼‰
        current_df = calculate_j_k_l_m_columns(current_df)
        
        # 3. æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
        comparison_df = create_comparison_dataframe(previous_df, current_df)
        
        # 4. æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ã®è¨ˆç®—ï¼ˆH, Iåˆ—ï¼‰
        comparison_df = calculate_comparison_columns(comparison_df)
        
        # 5. æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ã®å‚™è€ƒè¡Œã‚’ä½œæˆ
        today = datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')
        comparison_comment = f"å‰å›ãƒ‡ãƒ¼ã‚¿ã¨ä»Šå›ãƒ‡ãƒ¼ã‚¿ã®æ¯”è¼ƒï¼ˆ{today}å‡¦ç†ï¼‰"
        
        # 6. Excelãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
        output = write_excel_with_sheets(
            previous_df, previous_comment,
            current_df, current_comment,
            comparison_df, comparison_comment
        )
        
        # 7. çµ±è¨ˆæƒ…å ±
        stats = {
            'previous_rows': len(previous_df),
            'current_rows': len(current_df),
            'comparison_rows': len(comparison_df),
            'processed_at': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        }
        
        return output, stats
    
    except Exception as e:
        raise ValueError(f"ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
```

---

## å‡¦ç†ãƒ•ãƒ­ãƒ¼å›³
```
process_excel_files(previous_file, current_file)
  â”‚
  â”œâ”€ 1. read_excel_with_comment(previous_file)
  â”‚    â†’ previous_df, previous_comment
  â”‚
  â”œâ”€ 2. read_excel_with_comment(current_file)
  â”‚    â†’ current_df, current_comment
  â”‚
  â”œâ”€ 3. calculate_j_k_l_m_columns(current_df)
  â”‚    â†’ current_dfï¼ˆJã€œMåˆ—è¿½åŠ ï¼‰
  â”‚
  â”œâ”€ 4. create_comparison_dataframe(previous_df, current_df)
  â”‚    â†’ comparison_dfï¼ˆAã€œGåˆ—ï¼‰
  â”‚
  â”œâ”€ 5. calculate_comparison_columns(comparison_df)
  â”‚    â†’ comparison_dfï¼ˆH, Iåˆ—è¿½åŠ ï¼‰
  â”‚
  â”œâ”€ 6. å‚™è€ƒè¡Œä½œæˆ
  â”‚    â†’ comparison_comment
  â”‚
  â”œâ”€ 7. write_excel_with_sheets(...)
  â”‚    â†’ output (BytesIO)
  â”‚
  â””â”€ 8. çµ±è¨ˆæƒ…å ±ä½œæˆ
       â†’ stats (dict)
```

---

## ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä¾‹

### tests/test_data_processor.py
```python
import sys
sys.path.append('..')

from modules.data_processor import process_excel_files

def test_full_process():
    """
    å…¨å‡¦ç†ã®ãƒ†ã‚¹ãƒˆ
    """
    previous_file = 'tests/sample_data/sample_å‰å›ãƒ‡ãƒ¼ã‚¿.xlsx'
    current_file = 'tests/sample_data/sample_ä»Šå›ãƒ‡ãƒ¼ã‚¿.xlsx'
    
    # å‡¦ç†å®Ÿè¡Œ
    output, stats = process_excel_files(previous_file, current_file)
    
    print("å‡¦ç†çµ±è¨ˆ:")
    print(f"- å‰å›ãƒ‡ãƒ¼ã‚¿: {stats['previous_rows']}è¡Œ")
    print(f"- ä»Šå›ãƒ‡ãƒ¼ã‚¿: {stats['current_rows']}è¡Œ")
    print(f"- æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿: {stats['comparison_rows']}è¡Œ")
    print(f"- å‡¦ç†æ—¥æ™‚: {stats['processed_at']}")
    
    # ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›ï¼ˆç¢ºèªç”¨ï¼‰
    with open('test_full_output.xlsx', 'wb') as f:
        f.write(output.getvalue())
    
    print("\nâœ… test_full_output.xlsxã«å‡ºåŠ›ã•ã‚Œã¾ã—ãŸ")
    print("âœ… Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦ã€3ã‚·ãƒ¼ãƒˆãŒæ­£ã—ãä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„")

if __name__ == '__main__':
    test_full_process()
```

---

## å®Ÿè£…æ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ­£ã—ãimport
- [ ] å‡¦ç†é †åºã‚’å®ˆã‚‹ï¼ˆèª­ã¿è¾¼ã¿â†’è¨ˆç®—â†’ãƒãƒƒãƒãƒ³ã‚°â†’è¨ˆç®—â†’å‡ºåŠ›ï¼‰
- [ ] å‚™è€ƒè¡Œã‚’ä¿æŒã—ã¦å‡ºåŠ›
- [ ] çµ±è¨ˆæƒ…å ±ï¼ˆè¡Œæ•°ã€å‡¦ç†æ—¥æ™‚ï¼‰ã‚’è¿”å´
- [ ] ã‚¨ãƒ©ãƒ¼æ™‚ã¯é©åˆ‡ãªä¾‹å¤–ã‚’raise

---

## æœ€çµ‚ã‚¹ãƒ†ãƒƒãƒ—

**ã“ã‚Œã§å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å®Ÿè£…ã‚¬ã‚¤ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸã€‚**

### æ¬¡ã«ã‚„ã‚‹ã“ã¨

1. **app.py ã®å®Ÿè£…**
   - 04_UIè¨­è¨ˆæ›¸.md ã‚’å†åº¦ç¢ºèª
   - Streamlit UIã‚’å®Ÿè£…

2. **çµ±åˆãƒ†ã‚¹ãƒˆ**
   - ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã§å‹•ä½œç¢ºèª
   - Streamlitã‚¢ãƒ—ãƒªã‚’èµ·å‹•: `streamlit run app.py`

3. **ãƒ‡ãƒãƒƒã‚°**
   - ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã‚‰05_ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»•æ§˜æ›¸ã‚’ç¢ºèª

---

## app.py ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
```python
import streamlit as st
import pandas as pd
from datetime import datetime
from io import BytesIO

from modules.data_processor import process_excel_files
from utils.file_validator import validate_file

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(
    page_title="ã‚¨ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿åŠ å·¥ã‚·ã‚¹ãƒ†ãƒ ",
    page_icon="ğŸ“Š",
    layout="centered"
)

# ã‚¿ã‚¤ãƒˆãƒ«
st.title("ğŸ“Š ã‚¨ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿åŠ å·¥ã‚·ã‚¹ãƒ†ãƒ ")
st.markdown("---")

# ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹åˆæœŸåŒ–
if 'processed' not in st.session_state:
    st.session_state['processed'] = False

# TODO: ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè£…
# TODO: å‡¦ç†å®Ÿè¡Œã‚»ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè£…
# TODO: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè£…
```