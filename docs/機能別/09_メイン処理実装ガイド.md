# メイン処理実装ガイド

## 対象ファイル
`modules/data_processor.py`

## このモジュールの役割
- 全モジュールを統合
- ファイル読み込み → 計算 → マッチング → Excel出力の一連の流れを制御
- 処理統計情報を返却

---

## 実装する関数

### process_excel_files()

#### 目的
2つのExcelファイルを入力し、加工済みExcelをBytesIOで返す

#### シグネチャ
```python
def process_excel_files(previous_file, current_file) -> tuple[BytesIO, dict]:
    """
    Excelファイルを処理して3シート出力を生成
    
    Args:
        previous_file: 前回データのファイル
        current_file: 今回データのファイル
    
    Returns:
        tuple: (出力ExcelのBytesIO, 処理統計dict)
    
    Raises:
        ValueError: 処理エラー
    """
```

#### 実装
```python
from io import BytesIO
from datetime import datetime
from utils.excel_handler import read_excel_with_comment, write_excel_with_sheets
from modules.calculator import calculate_j_k_l_m_columns, calculate_comparison_columns
from modules.matcher import create_comparison_dataframe

def process_excel_files(previous_file, current_file):
    """
    Excelファイルを処理して3シート出力を生成
    """
    try:
        # 1. ファイル読み込み
        previous_df, previous_comment = read_excel_with_comment(previous_file)
        current_df, current_comment = read_excel_with_comment(current_file)
        
        # 2. 今回データの計算（J〜M列）
        current_df = calculate_j_k_l_m_columns(current_df)
        
        # 3. 比較データの作成
        comparison_df = create_comparison_dataframe(previous_df, current_df)
        
        # 4. 比較データの計算（H, I列）
        comparison_df = calculate_comparison_columns(comparison_df)
        
        # 5. 比較データの備考行を作成
        today = datetime.now().strftime('%Y年%m月%d日')
        comparison_comment = f"前回データと今回データの比較（{today}処理）"
        
        # 6. Excelファイル生成
        output = write_excel_with_sheets(
            previous_df, previous_comment,
            current_df, current_comment,
            comparison_df, comparison_comment
        )
        
        # 7. 統計情報
        stats = {
            'previous_rows': len(previous_df),
            'current_rows': len(current_df),
            'comparison_rows': len(comparison_df),
            'processed_at': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        }
        
        return output, stats
    
    except Exception as e:
        raise ValueError(f"データ処理中にエラーが発生しました: {str(e)}")
```

---

## 処理フロー図
```
process_excel_files(previous_file, current_file)
  │
  ├─ 1. read_excel_with_comment(previous_file)
  │    → previous_df, previous_comment
  │
  ├─ 2. read_excel_with_comment(current_file)
  │    → current_df, current_comment
  │
  ├─ 3. calculate_j_k_l_m_columns(current_df)
  │    → current_df（J〜M列追加）
  │
  ├─ 4. create_comparison_dataframe(previous_df, current_df)
  │    → comparison_df（A〜G列）
  │
  ├─ 5. calculate_comparison_columns(comparison_df)
  │    → comparison_df（H, I列追加）
  │
  ├─ 6. 備考行作成
  │    → comparison_comment
  │
  ├─ 7. write_excel_with_sheets(...)
  │    → output (BytesIO)
  │
  └─ 8. 統計情報作成
       → stats (dict)
```

---

## テストコード例

### tests/test_data_processor.py
```python
import sys
sys.path.append('..')

from modules.data_processor import process_excel_files

def test_full_process():
    """
    全処理のテスト
    """
    previous_file = 'tests/sample_data/sample_前回データ.xlsx'
    current_file = 'tests/sample_data/sample_今回データ.xlsx'
    
    # 処理実行
    output, stats = process_excel_files(previous_file, current_file)
    
    print("処理統計:")
    print(f"- 前回データ: {stats['previous_rows']}行")
    print(f"- 今回データ: {stats['current_rows']}行")
    print(f"- 比較データ: {stats['comparison_rows']}行")
    print(f"- 処理日時: {stats['processed_at']}")
    
    # ファイル出力（確認用）
    with open('test_full_output.xlsx', 'wb') as f:
        f.write(output.getvalue())
    
    print("\n✅ test_full_output.xlsxに出力されました")
    print("✅ Excelファイルを開いて、3シートが正しく作成されているか確認してください")

if __name__ == '__main__':
    test_full_process()
```

---

## 実装時のチェックリスト

- [ ] 全モジュールを正しくimport
- [ ] 処理順序を守る（読み込み→計算→マッチング→計算→出力）
- [ ] 備考行を保持して出力
- [ ] 統計情報（行数、処理日時）を返却
- [ ] エラー時は適切な例外をraise

---

## 最終ステップ

**これで全モジュールの実装ガイドが完了しました。**

### 次にやること

1. **app.py の実装**
   - 04_UI設計書.md を再度確認
   - Streamlit UIを実装

2. **統合テスト**
   - サンプルデータで動作確認
   - Streamlitアプリを起動: `streamlit run app.py`

3. **デバッグ**
   - エラーが出たら05_エラーハンドリング仕様書を確認

---

## app.py のテンプレート
```python
import streamlit as st
import pandas as pd
from datetime import datetime
from io import BytesIO

from modules.data_processor import process_excel_files
from utils.file_validator import validate_file

# ページ設定
st.set_page_config(
    page_title="エクセルデータ加工システム",
    page_icon="📊",
    layout="centered"
)

# タイトル
st.title("📊 エクセルデータ加工システム")
st.markdown("---")

# セッション状態初期化
if 'processed' not in st.session_state:
    st.session_state['processed'] = False

# TODO: ファイルアップロードセクション実装
# TODO: 処理実行セクション実装
# TODO: ダウンロードセクション実装
```