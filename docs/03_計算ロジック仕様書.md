# 計算ロジック仕様書

## 概要

このシステムには2種類の計算があります：
1. **今回データの計算**（J〜M列）
2. **比較データの計算**（H, I列）

---

## 1. 今回データの計算（J〜M列）

### 共通定数
```python
坪単価換算係数 = 0.3025
平米単価係数 = 70
```

---

### J列: 新築換算平均価格

#### 計算式
```
J = ROUND(F × 0.3025 × 70, 0)
```

#### Pythonコード例
```python
def calculate_j(f_value):
    """
    J列: 新築換算平均価格を計算
    
    Args:
        f_value: F列の値（priceunitconvnewly）
    
    Returns:
        計算結果（整数） or "データなし"
    """
    if pd.isna(f_value) or f_value == 0:
        return "データなし"
    
    result = round(f_value * 0.3025 * 70, 0)
    return int(result)
```

#### テストケース
| F列の値 | 期待されるJ列 |
|---------|---------------|
| 450000 | 9,528,750 → 9528750 |
| 0 | データなし |
| None | データなし |
| 空白 | データなし |

---

### K列: 新築時平均価格

#### 計算式
```
K = ROUND(G × 0.3025 × 70, 0)
```

#### Pythonコード例
```python
def calculate_k(g_value):
    """
    K列: 新築時平均価格を計算
    
    Args:
        g_value: G列の値（priceunitnewly）
    
    Returns:
        計算結果（整数） or "データなし"
    """
    if pd.isna(g_value) or g_value == 0:
        return "データなし"
    
    result = round(g_value * 0.3025 * 70, 0)
    return int(result)
```

---

### L列: 中古平均価格

#### 計算式
```
L = ROUND(H × 0.3025 × 70, 0)
```

#### Pythonコード例
```python
def calculate_l(h_value):
    """
    L列: 中古平均価格を計算
    
    Args:
        h_value: H列の値（priceunitusedsigned）
    
    Returns:
        計算結果（整数） or "データなし"
    """
    if pd.isna(h_value) or h_value == 0:
        return "データなし"
    
    result = round(h_value * 0.3025 * 70, 0)
    return int(result)
```

---

### M列: 新築換算ー中古

#### 計算式
```
M = J - L
```

#### 注意事項
⚠️ JまたはLが「データなし」の場合、Mも「データなし」

#### Pythonコード例
```python
def calculate_m(j_value, l_value):
    """
    M列: 新築換算ー中古を計算
    
    Args:
        j_value: J列の値
        l_value: L列の値
    
    Returns:
        計算結果（整数） or "データなし"
    """
    if j_value == "データなし" or l_value == "データなし":
        return "データなし"
    
    return int(j_value - l_value)
```

#### テストケース
| J列 | L列 | M列 |
|-----|-----|-----|
| 9528750 | 8041500 | 1487250 |
| データなし | 8041500 | データなし |
| 9528750 | データなし | データなし |
| データなし | データなし | データなし |

---

## 2. 比較データの計算（H, I列）

### H列: 差異

#### 計算式
```
H = G（今回新築換算平均価格） - F（前回新築換算平均価格）
```

#### Pythonコード例
```python
def calculate_diff(current_value, previous_value):
    """
    H列: 差異を計算
    
    Args:
        current_value: 今回のJ列値
        previous_value: 前回のJ列値
    
    Returns:
        計算結果（整数） or "データなし"
    """
    if (current_value == "データなし" or previous_value == "データなし" or
        pd.isna(current_value) or pd.isna(previous_value)):
        return "データなし"
    
    return int(current_value - previous_value)
```

---

### I列: 値上げ率

#### 計算式
```
I = (G / F - 1) × 100
※ 小数点以下切り上げ
```

#### 重要ポイント
✅ **必ず `math.ceil()` を使用**（切り上げ）
❌ `round()` は使わない

#### Pythonコード例
```python
import math

def calculate_rate(current_value, previous_value):
    """
    I列: 値上げ率を計算（切り上げ）
    
    Args:
        current_value: 今回のJ列値
        previous_value: 前回のJ列値
    
    Returns:
        計算結果（%、整数） or "データなし"
    """
    if (current_value == "データなし" or previous_value == "データなし" or
        pd.isna(current_value) or pd.isna(previous_value) or
        previous_value == 0):
        return "データなし"
    
    rate = (current_value / previous_value - 1) * 100
    return math.ceil(rate)  # 切り上げ
```

#### テストケース
| 前回（F） | 今回（G） | 計算 | 期待値 |
|-----------|-----------|------|--------|
| 9000000 | 9500000 | 5.56% | 6% |
| 9000000 | 9450000 | 5.00% | 5% |
| 9000000 | 9001000 | 0.01% | 1% |
| 9000000 | 8900000 | -1.11% | -1% |
| データなし | 9500000 | - | データなし |
| 9000000 | データなし | - | データなし |
| 0 | 9500000 | - | データなし |

---

## 一括計算の実装方針

### DataFrameへの適用
```python
# 今回データの計算
df['新築換算平均価格'] = df.apply(
    lambda row: calculate_j(row['priceunitconvnewly']), axis=1
)
df['新築時平均価格'] = df.apply(
    lambda row: calculate_k(row['priceunitnewly']), axis=1
)
df['中古平均価格'] = df.apply(
    lambda row: calculate_l(row['priceunitusedsigned']), axis=1
)
df['新築換算ー中古'] = df.apply(
    lambda row: calculate_m(row['新築換算平均価格'], row['中古平均価格']), axis=1
)

# 比較データの計算
comparison_df['差異'] = comparison_df.apply(
    lambda row: calculate_diff(row['今回新築換算平均価格'], row['前回新築換算平均価格']), axis=1
)
comparison_df['値上げ率'] = comparison_df.apply(
    lambda row: calculate_rate(row['今回新築換算平均価格'], row['前回新築換算平均価格']), axis=1
)
```

---

## 次のステップ

**04_UI設計書.md を読んで、Streamlitの画面仕様を理解してください**