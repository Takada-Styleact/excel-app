# アプリ使用マニュアル

## 🌐 オンライン版（推奨）

**アプリURL**: https://excel-app-enseneki.streamlit.app/

ブラウザでアクセスするだけですぐに使用できます。インストール不要！

---

## 目次
1. [システム概要](#システム概要)
2. [使い方](#使い方)
3. [トラブルシューティング](#トラブルシューティング)
4. [ローカル環境での実行](#ローカル環境での実行)（開発者向け）

---

## システム概要

### アプリケーション名
**エクセルデータ加工システム（Streamlit版）**

### 機能概要
2つのExcel/CSVファイル（前回データ・今回データ）を比較・加工し、4シートを含む1つのExcelファイルを出力します。

### 主な機能
- ✅ **複数形式対応**: Excel（.xlsx）とCSV（.csv）の両方に対応
- ✅ **自動エンコーディング検出**: 日本語CSVファイルを自動判定（Shift-JIS、UTF-8など）
- ✅ **異常値検出**: 値上げ率が指定した基準値（デフォルト±20%）以上のデータを自動抽出
- ✅ **柔軟なデータ構造**: 備考行あり/なしの両方に対応

### 出力ファイル構成
| シート名 | 内容 |
|---------|------|
| 前回データ | アップロードした前回データ（1行目に列説明を追加） |
| 今回データ | 今回データにJ～M列（新築換算平均価格、新築時平均価格、中古平均価格、新築換算ー中古）を追加 |
| 比較データ | 前回データと今回データをマッチングし、差異と値上げ率を計算 |
| 異常値シート | 値上げ率が基準値以上のデータのみ抽出（降順ソート） |

---

## 使い方

### ステップ1: アプリにアクセス

https://excel-app-enseneki.streamlit.app/ をブラウザで開きます。

---

### ステップ2: ファイルのアップロード

#### 前回データのアップロード
1. 左側の「前回データ」セクションで「Browse files」ボタンをクリック
2. 前回データのファイル（.xlsx または .csv）を選択
3. ファイル名が表示され、✅マークが表示されれば成功

#### 今回データのアップロード
1. 右側の「今回データ」セクションで「Browse files」ボタンをクリック
2. 今回データのファイル（.xlsx または .csv）を選択
3. ファイル名が表示され、✅マークが表示されれば成功

#### 対応ファイル形式
- **Excel**: `.xlsx` 形式（.xlsは非対応）
- **CSV**: `.csv` 形式（Shift-JIS、UTF-8、UTF-8 BOMなど自動判定）

#### ファイル構造
以下の2パターンに対応（自動判定）:

**パターン1: 備考行あり**
```
1行目: 備考行（任意のテキスト）
2行目: ヘッダー行（stationid, railroad など）
3行目以降: データ行
```

**パターン2: 備考行なし**
```
1行目: ヘッダー行（stationid, railroad など）
2行目以降: データ行
```

- **必須カラム**: `stationid`, `railroad`

---

### ステップ3: 異常値の基準設定

1. 「異常値の基準（±%）」の入力欄で基準値を設定（デフォルト: 20）
2. この値以上の値上げ率のデータが「異常値シート」に抽出されます
3. 例: 30に設定すると、±30%以上のデータのみ抽出

---

### ステップ4: データ処理の実行

1. 両方のファイルをアップロードすると、「🚀 データ処理を実行」ボタンが有効になります
2. ボタンをクリックすると処理が開始されます
3. 処理中は「処理中です...しばらくお待ちください」というメッセージが表示されます

#### 処理内容
- **今回データの計算**: J～M列を自動計算
  - J列: 新築換算平均価格 = `priceunitconvnewly × 0.3025 × 70`
  - K列: 新築時平均価格 = `priceunitnewly × 0.3025 × 70`
  - L列: 中古平均価格 = `priceunitusedsigned × 0.3025 × 70`
  - M列: 新築換算ー中古 = `J列 - L列`

- **データマッチング**: `stationid + railroad` でマッチング

- **比較データの計算**:
  - H列: 差異 = `今回新築換算平均価格 - 前回新築換算平均価格`
  - I列: 値上げ率 = `(今回 / 前回 - 1) × 100`（切り上げ、%記号付き）

- **異常値抽出**: 設定した基準値以上の値上げ率のデータを抽出し、降順ソート

#### 処理完了
処理が完了すると、以下の情報が表示されます：
```
✅ 処理が完了しました！

📊 処理結果
- 前回データ: XX行
- 今回データ: XX行
- 比較データ: XX行
- 異常値データ: XX行
```

---

### ステップ5: 結果のダウンロード

1. 処理完了後、「📥 結果をダウンロード」ボタンが表示されます
2. ボタンをクリックすると、Excelファイルがダウンロードされます
3. ファイル名は `output_YYYYMMDD_HHMMSS.xlsx` の形式で自動生成されます
   - 例: `output_20250123_143052.xlsx`

#### ダウンロードファイルの確認
1. ダウンロードしたExcelファイルを開く
2. 4つのシートが作成されていることを確認
   - シート1: **前回データ**（1行目に列説明あり）
   - シート2: **今回データ**（J～M列が追加、1行目に列説明あり）
   - シート3: **比較データ**（差異と値上げ率が表示）
   - シート4: **異常値シート**（基準値以上のデータのみ、値上げ率降順）
3. ヘッダー行（2行目）の一部の列に色が付いていることを確認
   - 黄色: 計算対象列（F, G, J, L列）
   - 橙色: 結果列（H, I, M列）

---

## トラブルシューティング

### よくあるエラーと対処法

#### 1. 「streamlit: command not found」エラー

**原因**: Streamlitがインストールされていない

**対処法**:
```bash
pip install -r requirements.txt
```

---

#### 2. 「.xlsx形式のファイルをアップロードしてください」エラー

**原因**: .xls形式や他の形式のファイルをアップロードした

**対処法**:
- Excelで「名前を付けて保存」→「Excel ブック (*.xlsx)」を選択して保存し直す

---

#### 3. 「必須カラムが見つかりません - stationid, railroad」エラー

**原因**: ファイルに必須カラムが含まれていない

**対処法**:
- ファイルの2行目（ヘッダー行）に `stationid` と `railroad` カラムがあることを確認
- カラム名のスペルミスや全角/半角の違いを確認

---

#### 4. 「データ行が見つかりませんでした」エラー

**原因**: ファイルにデータ行が含まれていない（ヘッダーのみ）

**対処法**:
- 3行目以降にデータが存在することを確認
- 空白行のみのファイルでないか確認

---

#### 5. 「データなし」が多く表示される

**原因**: 計算元のデータ（F, G, H列）に0や空白が多い

**対処法**:
- これは正常な動作です
- F列（priceunitconvnewly）、G列（priceunitnewly）、H列（priceunitusedsigned）に有効な数値データがない場合、「データなし」と表示されます

---

#### 6. マッチングされないデータがある

**原因**: `stationid + railroad` の組み合わせが前回と今回で一致しない

**対処法**:
- これは正常な動作です
- 比較データでは、前回のみ・今回のみのデータも「データなし」として表示されます
- stationidやrailroadの表記揺れ（全角/半角、スペースの有無）を確認

---

#### 7. アプリケーションが起動しない

**原因**: ポートが既に使用されている

**対処法**:
```bash
# 別のポート番号で起動
python -m streamlit run app.py --server.port 8502
```

または、既存のStreamlitプロセスを終了：
```bash
# Windowsの場合
taskkill /F /IM streamlit.exe

# macOS/Linuxの場合
pkill -f streamlit
```

---

#### 8. CSVファイルのエンコーディングエラー

**エラー例**: 「utf-8コーデックは位置XXのバイトをデコードできません」

**原因**: CSVファイルのエンコーディングが自動検出できない特殊な文字コードを使用している

**対処法**:
- CSVファイルをExcel形式(.xlsx)に変換して再アップロード
- CSVファイルをUTF-8 BOM付きで保存し直す:
  1. Excelで開く
  2. 「名前を付けて保存」→「CSV UTF-8 (コンマ区切り) (*.csv)」を選択
  3. 保存したファイルをアップロード

---

#### 9. メモリ不足エラー

**原因**: 大きなファイル（数万行以上）を処理しようとした

**対処法**:
- ファイルサイズを10MB以下に抑える
- データを分割して処理する
- メモリを増設する

---

### サンプルデータで動作確認

初めて使用する場合は、サンプルデータで動作確認することをおすすめします。

#### サンプルデータの場所
```
Excel_App/tests/sample_data/
├── sample_前回データ.xlsx
└── sample_今回データ.xlsx
```

#### 動作確認手順
1. アプリケーションを起動
2. `sample_前回データ.xlsx` を前回データとしてアップロード
3. `sample_今回データ.xlsx` を今回データとしてアップロード
4. 「データ処理を実行」をクリック
5. 処理が正常に完了し、ダウンロードボタンが表示されることを確認

---

## ローカル環境での実行

オンライン版ではなく、自分のパソコンでアプリを実行したい開発者向けの説明です。

### 必要要件

#### システム要件
- **OS**: Windows 10/11, macOS, Linux
- **Python**: 3.9以上（推奨: 3.11）
- **メモリ**: 最低4GB（推奨: 8GB以上）
- **ディスク容量**: 100MB以上の空き容量

#### 必要なソフトウェア
- Python 3.9以上
- pip（Pythonパッケージマネージャー）
- Git（GitHubからクローンする場合）

### セットアップ手順

#### 1. リポジトリのクローン
```bash
git clone https://github.com/Takada-Styleact/excel-app.git
cd excel-app
```

#### 2. Pythonのインストール確認
```bash
python --version
```
または
```bash
python3 --version
```

#### 3. 必要パッケージのインストール
```bash
pip install -r requirements.txt
```

**インストールされるパッケージ:**
- `streamlit>=1.31.0` - Webアプリケーションフレームワーク
- `pandas>=2.0.0` - データ処理ライブラリ
- `openpyxl>=3.1.0` - Excel読み書きライブラリ
- `numpy>=1.24.0` - 数値計算ライブラリ

#### 4. インストール確認
```bash
python -m streamlit --version
```

### アプリケーションの起動

#### Windowsの場合
```bash
python -m streamlit run app.py
```

#### macOS/Linuxの場合
```bash
python3 -m streamlit run app.py
```

### 起動オプション

#### ポート番号を指定して起動
```bash
python -m streamlit run app.py --server.port 8502
```

#### ヘッドレスモードで起動（サーバー環境）
```bash
python -m streamlit run app.py --server.headless true
```

### 起動確認

アプリケーションが正常に起動すると、以下のようなメッセージが表示されます：

```
You can now view your Streamlit app in your browser.

  Local URL: http://localhost:8501
  Network URL: http://192.168.x.x:8501
```

ブラウザで表示されたURLにアクセスしてください。

### アプリケーションの停止

#### ターミナルで実行している場合
```
Ctrl + C
```

#### バックグラウンドで実行している場合（Windows）
```bash
taskkill /F /IM streamlit.exe
```

#### バックグラウンドで実行している場合（macOS/Linux）
```bash
pkill -f streamlit
```

---

## お問い合わせ

### 技術サポート
- プロジェクトのGitHubリポジトリでIssueを作成
- 詳細なエラーメッセージやログを添付してください

### バグ報告
以下の情報を含めて報告してください：
- OS・Pythonのバージョン
- エラーメッセージの全文
- 再現手順
- 使用したファイルのサンプル（可能であれば）

---

## 更新履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.3.0 | 2025-10-23 | オンライン版対応、CSV形式サポート、異常値シート機能、基準値設定機能を追加 |
| 1.0.0 | 2025-10-17 | 初版リリース |

---

## ライセンス

このプロジェクトは内部使用を目的としています。
