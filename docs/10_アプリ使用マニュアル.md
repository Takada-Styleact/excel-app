# アプリ使用マニュアル

## 目次
1. [システム概要](#システム概要)
2. [環境構築](#環境構築)
3. [アプリケーションの起動](#アプリケーションの起動)
4. [使い方](#使い方)
5. [トラブルシューティング](#トラブルシューティング)

---

## システム概要

### アプリケーション名
**エクセルデータ加工システム（Streamlit版）**

### 機能概要
2つのExcelファイル（前回データ・今回データ）を比較・加工し、3シートを含む1つのExcelファイルを出力します。

### 出力ファイル構成
| シート名 | 内容 |
|---------|------|
| 前回データ | アップロードした前回データをそのまま出力 |
| 今回データ | 今回データにJ～M列（新築換算平均価格、新築時平均価格、中古平均価格、新築換算ー中古）を追加 |
| 比較データ | 前回データと今回データをマッチングし、差異と値上げ率を計算 |

---

## 環境構築

### 必要要件

#### システム要件
- **OS**: Windows 10/11, macOS, Linux
- **Python**: 3.9以上（推奨: 3.11）
- **メモリ**: 最低4GB（推奨: 8GB以上）
- **ディスク容量**: 100MB以上の空き容量

#### 必要なソフトウェア
- Python 3.9以上
- pip（Pythonパッケージマネージャー）

### セットアップ手順

#### 1. Pythonのインストール確認
```bash
python --version
```
または
```bash
python3 --version
```

#### 2. プロジェクトディレクトリへ移動
```bash
cd Excel_App
```

#### 3. 必要パッケージのインストール
```bash
pip install -r requirements.txt
```

**インストールされるパッケージ:**
- `streamlit==1.31.0` - Webアプリケーションフレームワーク
- `pandas==2.2.0` - データ処理ライブラリ
- `openpyxl==3.1.2` - Excel読み書きライブラリ
- `numpy==1.26.3` - 数値計算ライブラリ

#### 4. インストール確認
```bash
python -m streamlit --version
```

---

## アプリケーションの起動

### 基本的な起動方法

#### Windowsの場合
```bash
cd Excel_App
python -m streamlit run app.py
```

#### macOS/Linuxの場合
```bash
cd Excel_App
python3 -m streamlit run app.py
```

### 起動オプション

#### ポート番号を指定して起動
```bash
python -m streamlit run app.py --server.port 8501
```

#### ヘッドレスモードで起動（サーバー環境）
```bash
python -m streamlit run app.py --server.headless true
```

#### ブラウザを自動で開かない
```bash
python -m streamlit run app.py --server.headless true
```

### 起動確認

アプリケーションが正常に起動すると、以下のようなメッセージが表示されます：

```
You can now view your Streamlit app in your browser.

  Local URL: http://localhost:8501
  Network URL: http://192.168.x.x:8501
```

ブラウザで表示されたURLにアクセスしてください。

---

## 使い方

### ステップ1: ファイルのアップロード

#### 前回データのアップロード
1. 左側の「前回データ」セクションで「Browse files」ボタンをクリック
2. 前回データのExcelファイル（.xlsx）を選択
3. ファイル名が表示され、✅マークが表示されれば成功

#### 今回データのアップロード
1. 右側の「今回データ」セクションで「Browse files」ボタンをクリック
2. 今回データのExcelファイル（.xlsx）を選択
3. ファイル名が表示され、✅マークが表示されれば成功

#### ファイル形式の要件
- **拡張子**: `.xlsx`（.xlsは非対応）
- **ファイル構造**:
  ```
  1行目: 備考行（任意のテキスト）
  2行目: カラム名（ヘッダー）
  3行目以降: データ
  ```
- **必須カラム**: `stationid`, `railroad`

---

### ステップ2: データ処理の実行

1. 両方のファイルをアップロードすると、「🚀 データ処理を実行」ボタンが有効になります
2. ボタンをクリックすると処理が開始されます
3. 処理中は「処理中です...しばらくお待ちください」というメッセージが表示されます

#### 処理内容
- **今回データの計算**: J～M列を自動計算
  - J列: 新築換算平均価格 = `priceunitconvnewly × 0.3025 × 70`
  - K列: 新築時平均価格 = `priceunitnewly × 0.3025 × 70`
  - L列: 中古平均価格 = `priceunitusedsigned × 0.3025 × 70`
  - M列: 新築換算ー中古 = `J列 - L列`

- **データマッチング**: `stationid + railroad` でマッチング

- **比較データの計算**:
  - H列: 差異 = `今回新築換算平均価格 - 前回新築換算平均価格`
  - I列: 値上げ率 = `(今回 / 前回 - 1) × 100`（切り上げ）

#### 処理完了
処理が完了すると、以下の情報が表示されます：
```
✅ 処理が完了しました！

📊 処理結果
- 前回データ: XX行
- 今回データ: XX行
- 比較データ: XX行
```

---

### ステップ3: 結果のダウンロード

1. 処理完了後、「📥 結果をダウンロード」ボタンが表示されます
2. ボタンをクリックすると、Excelファイルがダウンロードされます
3. ファイル名は `output_YYYYMMDD_HHMMSS.xlsx` の形式で自動生成されます
   - 例: `output_20250117_143052.xlsx`

#### ダウンロードファイルの確認
1. ダウンロードしたExcelファイルを開く
2. 3つのシートが作成されていることを確認
   - シート1: 前回データ
   - シート2: 今回データ（J～M列が追加されている）
   - シート3: 比較データ（差異と値上げ率が表示されている）

---

## トラブルシューティング

### よくあるエラーと対処法

#### 1. 「streamlit: command not found」エラー

**原因**: Streamlitがインストールされていない

**対処法**:
```bash
pip install -r requirements.txt
```

---

#### 2. 「.xlsx形式のファイルをアップロードしてください」エラー

**原因**: .xls形式や他の形式のファイルをアップロードした

**対処法**:
- Excelで「名前を付けて保存」→「Excel ブック (*.xlsx)」を選択して保存し直す

---

#### 3. 「必須カラムが見つかりません - stationid, railroad」エラー

**原因**: ファイルに必須カラムが含まれていない

**対処法**:
- ファイルの2行目（ヘッダー行）に `stationid` と `railroad` カラムがあることを確認
- カラム名のスペルミスや全角/半角の違いを確認

---

#### 4. 「データ行が見つかりませんでした」エラー

**原因**: ファイルにデータ行が含まれていない（ヘッダーのみ）

**対処法**:
- 3行目以降にデータが存在することを確認
- 空白行のみのファイルでないか確認

---

#### 5. 「データなし」が多く表示される

**原因**: 計算元のデータ（F, G, H列）に0や空白が多い

**対処法**:
- これは正常な動作です
- F列（priceunitconvnewly）、G列（priceunitnewly）、H列（priceunitusedsigned）に有効な数値データがない場合、「データなし」と表示されます

---

#### 6. マッチングされないデータがある

**原因**: `stationid + railroad` の組み合わせが前回と今回で一致しない

**対処法**:
- これは正常な動作です
- 比較データでは、前回のみ・今回のみのデータも「データなし」として表示されます
- stationidやrailroadの表記揺れ（全角/半角、スペースの有無）を確認

---

#### 7. アプリケーションが起動しない

**原因**: ポートが既に使用されている

**対処法**:
```bash
# 別のポート番号で起動
python -m streamlit run app.py --server.port 8502
```

または、既存のStreamlitプロセスを終了：
```bash
# Windowsの場合
taskkill /F /IM streamlit.exe

# macOS/Linuxの場合
pkill -f streamlit
```

---

#### 8. メモリ不足エラー

**原因**: 大きなファイル（数万行以上）を処理しようとした

**対処法**:
- ファイルサイズを10MB以下に抑える
- データを分割して処理する
- メモリを増設する

---

### サンプルデータで動作確認

初めて使用する場合は、サンプルデータで動作確認することをおすすめします。

#### サンプルデータの場所
```
Excel_App/tests/sample_data/
├── sample_前回データ.xlsx
└── sample_今回データ.xlsx
```

#### 動作確認手順
1. アプリケーションを起動
2. `sample_前回データ.xlsx` を前回データとしてアップロード
3. `sample_今回データ.xlsx` を今回データとしてアップロード
4. 「データ処理を実行」をクリック
5. 処理が正常に完了し、ダウンロードボタンが表示されることを確認

---

## 終了方法

### アプリケーションの停止

#### ターミナルで実行している場合
```
Ctrl + C
```

#### バックグラウンドで実行している場合（Windows）
```bash
taskkill /F /IM streamlit.exe
```

#### バックグラウンドで実行している場合（macOS/Linux）
```bash
pkill -f streamlit
```

---

## お問い合わせ

### 技術サポート
- プロジェクトのGitHubリポジトリでIssueを作成
- 詳細なエラーメッセージやログを添付してください

### バグ報告
以下の情報を含めて報告してください：
- OS・Pythonのバージョン
- エラーメッセージの全文
- 再現手順
- 使用したファイルのサンプル（可能であれば）

---

## 更新履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0.0 | 2025-10-17 | 初版リリース |

---

## ライセンス

このプロジェクトは内部使用を目的としています。
